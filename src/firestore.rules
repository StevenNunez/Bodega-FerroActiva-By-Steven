rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isUser(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function getUserRole() {
        return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    function getTenantId() {
        return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId;
    }
    
    function isSameTenant(resource) {
        return getTenantId() == resource.data.tenantId;
    }

    function hasRole(role) {
      return isSignedIn() && getUserRole() == role;
    }
    
    function hasAnyRole(roles) {
      return isSignedIn() && getUserRole() in roles;
    }
    
    function isSuperAdmin() {
        return hasRole('super-admin');
    }

    // --- Collections Rules ---

    // Users: Users can read their own data. Admins can manage users in their tenant.
    match /users/{userId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn(); // A user is created along with auth.
      allow update: if isUser(userId) || (hasAnyRole(['admin', 'super-admin']) && isSameTenant(resource));
      allow delete: if hasAnyRole(['admin', 'super-admin']);
    }
    
    // Tenants: Only super-admins can manage tenants.
    match /tenants/{tenantId} {
        allow read, write: if isSuperAdmin();
    }

    // Materials: Readable by all signed-in users, writable by warehouse admins and operations.
    match /materials/{materialId} {
      allow read: if hasAnyRole(['admin', 'bodega-admin', 'operations', 'supervisor', 'apr']);
      allow create, update, delete: if hasAnyRole(['bodega-admin', 'operations', 'admin']);
    }
    
    // Material Categories: Readable by all, writable by warehouse admins, ops, and supervisors.
    match /materialCategories/{categoryId} {
        allow read: if isSignedIn();
        allow create, update: if hasAnyRole(['admin', 'operations', 'supervisor', 'bodega-admin']);
        allow delete: if hasAnyRole(['admin', 'bodega-admin']);
    }
    
    // Units: Readable by all, created by anyone (for flexibility), managed by admins.
    match /units/{unitId} {
       allow read: if isSignedIn();
       allow create: if isSignedIn();
       allow update, delete: if hasAnyRole(['admin', 'bodega-admin']);
    }

    // Tools: Readable by all, managed by warehouse admins.
    match /tools/{toolId} {
       allow read: if isSignedIn();
       allow create, update, delete: if hasAnyRole(['admin', 'bodega-admin']);
    }

    // Suppliers: Readable by all, managed by admins and operations.
    match /suppliers/{supplierId} {
       allow read: if isSignedIn();
       allow create, update: if hasAnyRole(['admin', 'operations', 'bodega-admin']);
       allow delete: if hasAnyRole(['admin', 'bodega-admin']);
    }
    
    // Material Requests: Users can create/read their own. Admins can manage all.
    match /materialRequests/{requestId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if hasAnyRole(['admin', 'bodega-admin']);
      allow delete: if hasAnyRole(['admin', 'bodega-admin']);
    }
    
    // Return Requests
    match /returnRequests/{requestId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn();
        allow update, delete: if hasAnyRole(['admin', 'bodega-admin']);
    }

    // Purchase Requests: Users can create/read their own. Operations/Admins can manage all.
    match /purchaseRequests/{purchaseRequestId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn();
        allow update: if hasAnyRole(['admin', 'operations']);
        allow delete: if hasAnyRole(['admin', 'operations']);
    }
    
    // Purchase Lots & Orders: Managed by operations.
    match /purchaseLots/{lotId} {
        allow read, write: if hasAnyRole(['operations', 'admin']);
    }
    match /purchaseOrders/{orderId} {
        allow read, write: if hasAnyRole(['operations', 'admin']);
    }

    // Tool Logs: Created/updated on checkout/return, readable by all.
    match /toolLogs/{logId} {
      allow read: if isSignedIn();
      allow create, update: if hasAnyRole(['admin', 'supervisor', 'apr', 'operations', 'bodega-admin']);
    }
    
    // Attendance Logs: Created by guards/admins, readable by admins/ops.
    match /attendanceLogs/{logId} {
      allow read: if hasAnyRole(['admin', 'operations', 'finance']);
      allow create, update, delete: if hasAnyRole(['guardia', 'admin']);
    }

    // Stock Movements: Created internally by other actions, readable by admins/ops.
    match /stockMovements/{movementId} {
        allow read: if hasAnyRole(['admin', 'operations', 'bodega-admin', 'finance']);
        allow write: if hasAnyRole(['admin', 'operations', 'bodega-admin']); // Only backend-like logic should write here
    }
    
    // Supplier Payments: Managed by finance and admins.
    match /supplierPayments/{paymentId} {
        allow read: if hasAnyRole(['admin', 'operations', 'finance']);
        allow write: if hasAnyRole(['admin', 'finance']);
    }
    
    // --- Safety Module ---
    match /safetyTemplates/{templateId} {
        allow read: if isSignedIn();
        allow write: if hasAnyRole(['admin', 'apr']);
    }

    match /assignedSafetyTasks/{taskId} {
        allow read: if isSignedIn();
        allow create: if hasAnyRole(['admin', 'apr']);
        allow update: if hasAnyRole(['admin', 'apr']) || (hasRole('supervisor') && request.resource.data.assigneeId == request.auth.uid);
    }
    
    match /safetyTaskResults/{resultId} {
        allow read: if isSignedIn();
        allow create: if hasAnyRole(['supervisor', 'apr']);
        allow update: if hasAnyRole(['apr', 'admin']);
    }
    
    match /safetyObservations/{observationId} {
        allow read: if isSignedIn();
        allow write: if hasAnyRole(['admin', 'apr', 'supervisor']);
    }
    
    match /unplannedInspections/{inspectionId} {
        allow read: if isSignedIn();
        allow write: if hasAnyRole(['admin', 'apr', 'supervisor']);
    }
  }
}

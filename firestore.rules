rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---
    function isSignedIn() {
      return request.auth != null;
    }

    function isUser(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function getUserRole(userId) {
        return get(/databases/$(database)/documents/users/$(userId)).data.role;
    }
    
    function getTenantId(userId) {
        return get(/databases/$(database)/documents/users/$(userId)).data.tenantId;
    }

    function hasRole(role) {
      return isSignedIn() && getUserRole(request.auth.uid) == role;
    }
    
    function hasAnyRole(roles) {
      return isSignedIn() && getUserRole(request.auth.uid) in roles;
    }
    
    function isSuperAdmin() {
        return hasRole('super-admin');
    }

    // --- Root Collections Rules ---

    // Users: Publicly readable for auth purposes, but only user or admin can edit.
    match /users/{userId} {
      allow read: if isSignedIn();
      allow create: if true; // New users are created during signup.
      allow update: if isUser(userId) || hasAnyRole(['admin', 'super-admin']);
      allow delete: if hasAnyRole(['admin', 'super-admin']);
    }
    
    // Tenants & Subscriptions: Only super-admins can manage.
    match /tenants/{tenantId} {
        allow read, write: if isSuperAdmin();
    }
    match /subscriptions/{subId} {
        allow read, write: if isSuperAdmin();
    }
    
    // --- Tenant-Specific Subcollections ---
    match /tenants/{tenantId}/{document=**} {
      // Allow read/write if the user belongs to the tenant.
      // More specific rules below will override this.
      allow read, write: if isSignedIn() && getTenantId(request.auth.uid) == tenantId;
    }

    // Materials: Readable by all in tenant, writable by admins/ops.
    match /tenants/{tenantId}/materials/{materialId} {
      allow read: if isSignedIn();
      allow create, update, delete: if hasAnyRole(['bodega-admin', 'operations', 'admin']);
    }
    
    // Material Categories: Readable by all, writable by admins, ops, supervisors.
    match /tenants/{tenantId}/materialCategories/{categoryId} {
        allow read: if isSignedIn();
        allow create, update: if hasAnyRole(['admin', 'operations', 'supervisor', 'bodega-admin']);
        allow delete: if hasAnyRole(['admin', 'bodega-admin']);
    }
    
    // Units: Readable by all, created by anyone, managed by admins.
    match /tenants/{tenantId}/units/{unitId} {
       allow read, create: if isSignedIn();
       allow update, delete: if hasAnyRole(['admin', 'bodega-admin']);
    }

    // Tools: Readable by all, managed by warehouse admins.
    match /tenants/{tenantId}/tools/{toolId} {
       allow read: if isSignedIn();
       allow create, update, delete: if hasAnyRole(['admin', 'bodega-admin']);
    }

    // Suppliers: Readable by all, managed by admins and operations.
    match /tenants/{tenantId}/suppliers/{supplierId} {
       allow read: if isSignedIn();
       allow create, update: if hasAnyRole(['admin', 'operations', 'bodega-admin']);
       allow delete: if hasAnyRole(['admin', 'bodega-admin']);
    }
    
    // Material Requests: Users can create/read their own. Admins manage all.
    match /tenants/{tenantId}/materialRequests/{requestId} {
      allow read: if isSignedIn();
      allow create: if hasAnyRole(['supervisor', 'apr', 'admin', 'operations']);
      allow update, delete: if hasAnyRole(['admin', 'bodega-admin']);
    }
    
    // Return Requests
    match /tenants/{tenantId}/returnRequests/{requestId} {
        allow read: if isSignedIn();
        allow create: if hasAnyRole(['supervisor', 'apr', 'admin', 'operations']);
        allow update, delete: if hasAnyRole(['admin', 'bodega-admin']);
    }

    // Purchase Requests: Users create, Ops/Admins manage.
    match /tenants/{tenantId}/purchaseRequests/{purchaseRequestId} {
        allow read: if isSignedIn();
        allow create: if hasAnyRole(['supervisor', 'apr', 'admin', 'operations']);
        allow update: if hasAnyRole(['admin', 'operations']);
        allow delete: if hasAnyRole(['admin', 'operations']);
    }
    
    // Purchase Lots & Orders: Managed by operations and admins.
    match /tenants/{tenantId}/purchaseLots/{lotId} {
        allow read, write: if hasAnyRole(['operations', 'admin']);
    }
    match /tenants/{tenantId}/purchaseOrders/{orderId} {
        allow read, write: if hasAnyRole(['operations', 'admin']);
    }

    // Tool Logs: Readable by all, created/updated by authorized roles.
    match /tenants/{tenantId}/toolLogs/{logId} {
      allow read: if isSignedIn();
      allow create, update: if hasAnyRole(['admin', 'supervisor', 'apr', 'operations', 'bodega-admin']);
    }
    
    // Attendance Logs: Created by guards/admins, readable by HR/ops.
    match /tenants/{tenantId}/attendanceLogs/{logId} {
      allow read: if hasAnyRole(['admin', 'operations', 'finance']);
      allow create, update, delete: if hasAnyRole(['guardia', 'admin']);
    }

    // Stock Movements: Created by backend logic, readable by relevant roles.
    match /tenants/{tenantId}/stockMovements/{movementId} {
        allow read: if hasAnyRole(['admin', 'operations', 'bodega-admin', 'finance']);
        allow write: if hasAnyRole(['admin', 'operations', 'bodega-admin']);
    }
    
    // Supplier Payments: Managed by finance and admins.
    match /tenants/{tenantId}/supplierPayments/{paymentId} {
        allow read: if hasAnyRole(['admin', 'operations', 'finance']);
        allow write: if hasAnyRole(['admin', 'finance']);
    }
    
    // --- Safety Module ---
    match /tenants/{tenantId}/safetyTemplates/{templateId} {
        allow read: if isSignedIn();
        allow write: if hasAnyRole(['admin', 'apr', 'operations']);
    }

    match /tenants/{tenantId}/assignedSafetyTasks/{taskId} {
        allow read: if isSignedIn();
        allow create: if hasAnyRole(['admin', 'apr', 'operations']);
        // Allow update by reviewer or the assigned supervisor
        allow update: if hasAnyRole(['admin', 'apr', 'operations']) || (hasRole('supervisor') && resource.data.supervisorId == request.auth.uid);
    }
    
    match /tenants/{tenantId}/safetyObservations/{observationId} {
        allow read: if isSignedIn();
        allow write: if hasAnyRole(['admin', 'apr', 'supervisor', 'operations']);
    }
    
    match /tenants/{tenantId}/unplannedInspections/{inspectionId} {
        allow read: if isSignedIn();
        allow write: if hasAnyRole(['admin', 'apr', 'supervisor', 'operations']);
    }

    // Audit Logs: Writable by any signed-in user, but not readable from client.
    match /tenants/{tenantId}/auditLogs/{logId} {
      allow read: if false; // Only accessible via backend/console
      allow write: if isSignedIn();
    }
  }
}
